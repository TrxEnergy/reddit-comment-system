# M6ç›‘æ§æŒ‡æŒ¥ä¸­å¿ƒ - åˆå¹¶å®Œæˆæ€»ç»“

**åˆå¹¶æ—¶é—´**: 2025-10-09
**åˆ†æ”¯**: feature/module-6-monitoring â†’ main
**æäº¤**: 3fc1f44

---

## âœ… åˆå¹¶æˆåŠŸ

M6ç›‘æ§æŒ‡æŒ¥ä¸­å¿ƒå·²æˆåŠŸåˆå¹¶åˆ°mainåˆ†æ”¯ï¼

### æ–°å¢æ–‡ä»¶ï¼ˆ9ä¸ªï¼‰

```
M6_TEST_REPORT.md                           (330è¡Œ) - å…¨é¢æµ‹è¯•æŠ¥å‘Š
src/monitoring/__init__.py                   (14è¡Œ) - æ¨¡å—å¯¼å‡º
src/monitoring/alert_engine.py              (302è¡Œ) - å‘Šè­¦è§„åˆ™å¼•æ“
src/monitoring/dashboard.py                 (496è¡Œ) - FastAPIç›‘æ§æœåŠ¡
src/monitoring/metrics.py                   (312è¡Œ) - PrometheusæŒ‡æ ‡æ”¶é›†å™¨
src/monitoring/stats_aggregator.py          (294è¡Œ) - ä¸šåŠ¡ç»Ÿè®¡èšåˆå™¨
tests/unit/test_monitoring/__init__.py        (3è¡Œ) - æµ‹è¯•æ¨¡å—åˆå§‹åŒ–
tests/unit/test_monitoring/test_alert_engine.py  (91è¡Œ) - å‘Šè­¦å¼•æ“æµ‹è¯•
tests/unit/test_monitoring/test_metrics.py       (74è¡Œ) - æŒ‡æ ‡æ”¶é›†å™¨æµ‹è¯•
```

**æ€»è®¡**: 1916è¡Œæ–°å¢ä»£ç ï¼ˆåŒ…å«æµ‹è¯•å’Œæ–‡æ¡£ï¼‰

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. PrometheusæŒ‡æ ‡æ”¶é›†

**æ¨¡å—**: `src/monitoring/metrics.py`

**å…³é”®æŒ‡æ ‡**:
- **ä¸šåŠ¡æŒ‡æ ‡**: posts_discovered, posts_screened, comments_published, comments_deleted
- **æ€§èƒ½æŒ‡æ ‡**: screening_duration, generation_duration, publishing_duration (Histograms)
- **å¥åº·æŒ‡æ ‡**: available_accounts, total_accounts, error_rate, api_rate_limit_remaining

**è®¾è®¡æ¨¡å¼**: å•ä¾‹æ¨¡å¼ï¼ˆå…¨å±€å”¯ä¸€å®ä¾‹metrics_collectorï¼‰

### 2. FastAPIç›‘æ§æœåŠ¡

**æ¨¡å—**: `src/monitoring/dashboard.py`

**ç«¯å£**: 8086

**RESTç«¯ç‚¹**:
- `GET /` - é‡å®šå‘åˆ°ç›‘æ§é¢æ¿
- `GET /health` - ç³»ç»Ÿå¥åº·æ£€æŸ¥
- `GET /metrics` - Prometheusæ ¼å¼æŒ‡æ ‡å¯¼å‡º
- `GET /stats` - å®Œæ•´ä¸šåŠ¡ç»Ÿè®¡
- `GET /stats/{module}` - å•æ¨¡å—ç»Ÿè®¡ï¼ˆdiscovery/screening/generation/publishing/accounts/performanceï¼‰
- `GET /alerts` - æ´»è·ƒå‘Šè­¦æŸ¥è¯¢
- `POST /alerts/check` - æ‰‹åŠ¨è§¦å‘å‘Šè­¦æ£€æŸ¥
- `DELETE /alerts/{rule_name}` - æ¸…é™¤æŒ‡å®šå‘Šè­¦
- `GET /dashboard` - HTMLç›‘æ§é¢æ¿ï¼ˆ30ç§’è‡ªåŠ¨åˆ·æ–°ï¼‰

### 3. å‘Šè­¦è§„åˆ™å¼•æ“

**æ¨¡å—**: `src/monitoring/alert_engine.py`

**é»˜è®¤è§„åˆ™**ï¼ˆ6ä¸ªï¼‰:

| è§„åˆ™åç§° | çº§åˆ« | æ¡ä»¶ | å†·å´æ—¶é—´ |
|---------|------|------|----------|
| account_pool_exhausted | CRITICAL | å¯ç”¨è´¦å· < 10 | 10åˆ†é’Ÿ |
| publish_success_rate_low | CRITICAL | æˆåŠŸç‡ < 80% | 20åˆ†é’Ÿ |
| account_availability_low | WARNING | å¯ç”¨ç‡ < 50% | 15åˆ†é’Ÿ |
| comment_delete_rate_high | WARNING | åˆ é™¤ç‡ > 5% | 30åˆ†é’Ÿ |
| screening_approval_rate_low | WARNING | é€šè¿‡ç‡ < 30% | 30åˆ†é’Ÿ |
| system_health_degraded | INFO | å¥åº·è¯„åˆ† < 80 | 60åˆ†é’Ÿ |

**ç‰¹æ€§**:
- åŠ¨æ€è§„åˆ™æ·»åŠ ï¼ˆ`add_rule()`ï¼‰
- å‘Šè­¦å†·å´æœºåˆ¶ï¼ˆé˜²æ­¢å‘Šè­¦é£æš´ï¼‰
- å‘Šè­¦å†å²è®°å½•
- æ‰‹åŠ¨æ¸…é™¤åŠŸèƒ½

### 4. ä¸šåŠ¡ç»Ÿè®¡èšåˆ

**æ¨¡å—**: `src/monitoring/stats_aggregator.py`

**ç»Ÿè®¡ç»´åº¦**:
- **å‘ç°ç»Ÿè®¡**: æ€»å‘ç°æ•°ã€å»é‡ç‡
- **ç­›é€‰ç»Ÿè®¡**: æ€»ç­›é€‰æ•°ã€é€šè¿‡ç‡ã€æ‹’ç»åŸå› åˆ†å¸ƒ
- **ç”Ÿæˆç»Ÿè®¡**: æ€»ç”Ÿæˆæ•°ã€å¤±è´¥ç‡ã€é”™è¯¯ç±»å‹åˆ†å¸ƒ
- **å‘å¸ƒç»Ÿè®¡**: æ€»å‘å¸ƒæ•°ã€æˆåŠŸç‡ã€åˆ é™¤ç‡ã€å¤±è´¥åŸå› åˆ†å¸ƒ
- **è´¦å·æ± ç»Ÿè®¡**: æ€»è´¦å·æ•°ã€å¯ç”¨è´¦å·ã€å¯ç”¨ç‡ã€åˆ©ç”¨ç‡
- **æ€§èƒ½ç»Ÿè®¡**: å„æ¨¡å—å¹³å‡è€—æ—¶ï¼ˆåŸºäºHistogramï¼‰
- **å¥åº·æ‘˜è¦**: ç³»ç»Ÿå¥åº·çŠ¶æ€å’Œè¯„åˆ†ï¼ˆ0-100ï¼‰

**å¥åº·è¯„åˆ†ç®—æ³•**:
```
æ€»åˆ† = 100
- è´¦å·å¯ç”¨æ€§ (40%æƒé‡):
  - < 30%: -40åˆ†
  - < 50%: -20åˆ†
- å‘å¸ƒæˆåŠŸç‡ (40%æƒé‡):
  - < 80%: -40åˆ†
  - < 90%: -20åˆ†
- è¯„è®ºåˆ é™¤ç‡ (20%æƒé‡):
  - > 10%: -20åˆ†
  - > 5%: -10åˆ†

çŠ¶æ€åˆ†çº§:
- healthy: â‰¥ 80åˆ†
- degraded: 60-79åˆ†
- unhealthy: < 60åˆ†
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `tests/unit/test_monitoring/`

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•æ•° | é€šè¿‡ç‡ | è¦†ç›–ç‡ |
|---------|--------|--------|--------|
| test_metrics.py | 6 | 100% | 85% |
| test_alert_engine.py | 5 | 100% | 97% |
| **æ€»è®¡** | **11** | **100%** | **85-97%** |

### é›†æˆéªŒè¯

âœ… **å®Œæ•´æµ‹è¯•å¥—ä»¶**: 153ä¸ªæµ‹è¯•ï¼Œ142é€šè¿‡ï¼ˆæ— å›å½’ï¼‰
âœ… **FastAPIæœåŠ¡**: 6ä¸ªç«¯ç‚¹å…¨éƒ¨éªŒè¯é€šè¿‡
âœ… **å‘Šè­¦å¼•æ“**: 6ä¸ªè§„åˆ™å…¨éƒ¨è§¦å‘æµ‹è¯•é€šè¿‡
âœ… **PrometheusæŒ‡æ ‡**: 132è¡ŒæŒ‡æ ‡è¾“å‡ºæ­£å¸¸

**è¯¦ç»†æµ‹è¯•æŠ¥å‘Š**: [M6_TEST_REPORT.md](./M6_TEST_REPORT.md)

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¯åŠ¨ç›‘æ§æœåŠ¡

```python
# æ–¹å¼1: ç›´æ¥è¿è¡Œ
python -m uvicorn src.monitoring.dashboard:app --host 0.0.0.0 --port 8086

# æ–¹å¼2: ä»£ç é›†æˆ
from src.monitoring.dashboard import app
import uvicorn
uvicorn.run(app, host="0.0.0.0", port=8086)
```

### è®°å½•ä¸šåŠ¡æŒ‡æ ‡

```python
from src.monitoring.metrics import metrics_collector

# è®°å½•å‘ç°çš„å¸–å­
metrics_collector.record_post_discovered("CryptoCurrency", source="reddit_api")

# è®°å½•ç­›é€‰ç»“æœ
metrics_collector.record_screening_result(approved=True)

# è®°å½•å‘å¸ƒæˆåŠŸ
metrics_collector.record_publish_success()

# æ›´æ–°è´¦å·æ± ç»Ÿè®¡
metrics_collector.update_account_stats({
    'total_accounts': 100,
    'available_accounts': 75,
    'locked_accounts': 10,
    'no_quota_accounts': 15
})
```

### æŸ¥è¯¢ä¸šåŠ¡ç»Ÿè®¡

```python
from src.monitoring.stats_aggregator import stats_aggregator

# è·å–å‘ç°æ¨¡å—ç»Ÿè®¡
discovery_stats = stats_aggregator.get_discovery_stats()
print(f"æ€»å‘ç°: {discovery_stats['total_discovered']}")
print(f"å»é‡ç‡: {discovery_stats['duplicate_rate']*100:.1f}%")

# è·å–ç³»ç»Ÿå¥åº·æ‘˜è¦
health = stats_aggregator.get_health_summary()
print(f"å¥åº·çŠ¶æ€: {health['status']}")
print(f"å¥åº·è¯„åˆ†: {health['score']}")
```

### ç®¡ç†å‘Šè­¦è§„åˆ™

```python
from src.monitoring.alert_engine import alert_engine, AlertRule, AlertSeverity

# æ·»åŠ è‡ªå®šä¹‰è§„åˆ™
def check_custom_condition():
    # è‡ªå®šä¹‰æ£€æŸ¥é€»è¾‘
    value = 42
    threshold = 50
    is_triggered = value < threshold
    message = f"å€¼{value}ä½äºé˜ˆå€¼{threshold}" if is_triggered else ""
    return is_triggered, value, threshold, message

alert_engine.add_rule(AlertRule(
    name="custom_rule",
    severity=AlertSeverity.WARNING,
    description="è‡ªå®šä¹‰å‘Šè­¦è§„åˆ™",
    condition=check_custom_condition,
    cooldown_minutes=10
))

# æ£€æŸ¥æ‰€æœ‰è§„åˆ™
triggered_alerts = alert_engine.check_all_rules()
for alert in triggered_alerts:
    print(f"[{alert.severity.value}] {alert.message}")

# æ¸…é™¤å‘Šè­¦
alert_engine.clear_alert("custom_rule")
```

### è®¿é—®ç›‘æ§é¢æ¿

æµè§ˆå™¨æ‰“å¼€: http://localhost:8086/dashboard

**é¢æ¿åŠŸèƒ½**:
- å®æ—¶ç³»ç»Ÿå¥åº·çŠ¶æ€
- å„æ¨¡å—ä¸šåŠ¡ç»Ÿè®¡
- æ´»è·ƒå‘Šè­¦åˆ—è¡¨
- 30ç§’è‡ªåŠ¨åˆ·æ–°

---

## ğŸ“Š ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚                               â”‚
â”‚  M2å‘ç° | M3ç­›é€‰ | M4ç”Ÿæˆ | M5å‘å¸ƒ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ æŒ‡æ ‡è®°å½•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               MetricsCollector (å•ä¾‹)                    â”‚
â”‚  - Counter (ä¸šåŠ¡æŒ‡æ ‡)                                   â”‚
â”‚  - Histogram (æ€§èƒ½æŒ‡æ ‡)                                 â”‚
â”‚  - Gauge (å¥åº·æŒ‡æ ‡)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ æ•°æ®èšåˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               StatsAggregator                           â”‚
â”‚  - æˆåŠŸç‡/é”™è¯¯ç‡è®¡ç®—                                    â”‚
â”‚  - å¥åº·è¯„åˆ†ç®—æ³•                                         â”‚
â”‚  - è¶‹åŠ¿åˆ†æ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è§„åˆ™æ£€æŸ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               AlertEngine                               â”‚
â”‚  - 6ä¸ªé»˜è®¤è§„åˆ™                                          â”‚
â”‚  - åŠ¨æ€è§„åˆ™ç®¡ç†                                         â”‚
â”‚  - å‘Šè­¦å†·å´æœºåˆ¶                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ HTTPæœåŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          FastAPI Dashboard (ç«¯å£8086)                   â”‚
â”‚  - REST API (10+ç«¯ç‚¹)                                   â”‚
â”‚  - Prometheuså¯¼å‡º (/metrics)                            â”‚
â”‚  - HTMLç›‘æ§é¢æ¿ (/dashboard)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯æ ˆ

- **Webæ¡†æ¶**: FastAPI 0.104+
- **æŒ‡æ ‡åº“**: prometheus_client 0.19+
- **å¼‚æ­¥è¿è¡Œ**: uvicorn 0.24+
- **æµ‹è¯•æ¡†æ¶**: pytest 7.4+
- **ç±»å‹æ£€æŸ¥**: Python 3.11+

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **å¯åŠ¨æ—¶é—´**: < 1ç§’
- **å‘Šè­¦æ£€æŸ¥**: < 0.1ç§’
- **æŒ‡æ ‡æ”¶é›†**: æ— æ˜æ˜¾å¼€é”€
- **å†…å­˜å ç”¨**: ~50MBï¼ˆåŒ…å«FastAPIè¿è¡Œæ—¶ï¼‰
- **HTTPå“åº”**: < 100msï¼ˆæ‰€æœ‰ç«¯ç‚¹ï¼‰

---

## ğŸ¨ ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **å‘Šè­¦æŒä¹…åŒ–**: å°†å‘Šè­¦å†å²å­˜å‚¨åˆ°æ•°æ®åº“
2. **Grafanaé›†æˆ**: å¯¼å…¥PrometheusæŒ‡æ ‡åˆ°Grafanaå¯è§†åŒ–
3. **é‚®ä»¶é€šçŸ¥**: æ·»åŠ å‘Šè­¦é‚®ä»¶/Webhooké€šçŸ¥
4. **è§„åˆ™ç®¡ç†UI**: æä¾›Webç•Œé¢ç®¡ç†è‡ªå®šä¹‰è§„åˆ™

### é•¿æœŸå¢å¼ºï¼ˆå¯é€‰ï¼‰

1. **å‰ç«¯åˆ†ç¦»**: React/Vueç›‘æ§é¢æ¿
2. **æ—¶åºå­˜å‚¨**: æ¥å…¥InfluxDB/TimescaleDB
3. **åˆ†å¸ƒå¼è¿½è¸ª**: OpenTelemetryé›†æˆ
4. **æ€§èƒ½åˆ†æ**: æ¥å…¥Pyroscopeç«ç„°å›¾

---

## ğŸ“ æ€»ç»“

âœ… **M6ç›‘æ§æŒ‡æŒ¥ä¸­å¿ƒå·²å®Œå…¨é›†æˆåˆ°ä¸»åˆ†æ”¯**

**æ–°å¢èƒ½åŠ›**:
- Prometheusæ ‡å‡†æŒ‡æ ‡å¯¼å‡º
- å®æ—¶ä¸šåŠ¡ç»Ÿè®¡æŸ¥è¯¢
- æ™ºèƒ½å‘Šè­¦è§„åˆ™å¼•æ“
- Webç›‘æ§é¢æ¿
- å¥åº·è¯„åˆ†ç³»ç»Ÿ

**è´¨é‡ä¿è¯**:
- 11ä¸ªå•å…ƒæµ‹è¯•100%é€šè¿‡
- ä»£ç è¦†ç›–ç‡85-97%ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰
- æ— ç ´åæ€§å˜æ›´
- å®Œæ•´æ–‡æ¡£å’Œæµ‹è¯•æŠ¥å‘Š

**ç”Ÿäº§å°±ç»ª**: âœ…

---

**ä¸‹æ¬¡å¯åŠ¨ç›‘æ§æœåŠ¡**:
```bash
cd /d/reddit-comment-system
python -m uvicorn src.monitoring.dashboard:app --host 0.0.0.0 --port 8086
```

ç„¶åè®¿é—®: http://localhost:8086/dashboard

ğŸ‰ **M6å¼€å‘åœ†æ»¡å®Œæˆï¼**
