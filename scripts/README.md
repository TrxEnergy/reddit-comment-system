# 测试脚本说明

本目录包含端到端测试脚本，用于完整流程测试。

---

## 📋 test_e2e_single_account.py

**用途**: 单个账号完整流程测试（M2→M3→M4→M5→M6）

**前置要求**:
1. `.env`文件已配置（OpenAI API密钥、Reddit凭据、本地账号文件路径）
2. 本地账号文件存在（`tokens.jsonl`）
3. Docker服务已启动（PostgreSQL + Redis）

**运行方式**:
```bash
cd /d/reddit-comment-system
python scripts/test_e2e_single_account.py
```

**测试流程**:
1. **M2发现** - 发现1-3个Reddit帖子（使用quick_scan配方）
2. **M3筛选** - 筛选出1个高质量帖子
3. **M4生成** - 生成1条自然评论
4. **M5发布** - 模拟发布到Reddit（不实际提交）
5. **M6监控** - 查看健康评分和指标

**预期输出**:
```
============================================================
  Reddit评论系统 - 单账号端到端测试
  时间: 2025-10-10 15:30:00
============================================================

============================================================
  阶段1: M2发现引擎
============================================================

✅ M2发现: 发现3个帖子，耗时5.2秒
  1. r/CryptoCurrency - What's the best way to transfer USDT...
  2. r/Tronix - New to TRX, need help with wallet...
  3. r/ethereum - Gas fees comparison...

============================================================
  阶段2: M3智能筛选
============================================================

✅ M3筛选: 通过1个帖子，耗时8.1秒
  1. r/CryptoCurrency - What's the best way to transfer USDT...
     分数: 0.82
     意图: A

============================================================
  阶段3: M4内容工厂
============================================================

✅ M4生成: 生成评论149字符，耗时12.3秒
  Persona: gas_optimizer
  评论预览: TRC20 USDT is definitely your cheapest option here. I've been using it for a while and the fees are...
  合规评分: 0.98

============================================================
  阶段4: M5发布协调
============================================================

  可用账号: 1个
  [模拟发布] 账号: k14vo0uk
  [模拟发布] 目标: r/CryptoCurrency/xyz123
  [模拟发布] 评论: TRC20 USDT is definitely your cheapest option...
✅ M5发布: 成功发布到 r/CryptoCurrency，耗时6.5秒

============================================================
  阶段5: M6监控中心
============================================================

  健康状态: healthy
  健康评分: 85/100
  账号可用率: 100.0%
✅ M6监控: 健康评分85/100，耗时0.1秒

============================================================
  测试总结
============================================================

  总耗时: 32.2秒
  成功模块: 5/5
  评论链接: https://reddit.com/r/CryptoCurrency/comments/xyz123

============================================================
  ✅ 所有模块测试通过！
============================================================
```

**遇到问题时**:
- 检查`.env`配置是否正确
- 确认本地账号文件路径正确
- 查看日志文件排查具体错误
- 参考`ENV_CONFIG_GUIDE.md`配置环境变量

---

## 🔧 修复问题流程

1. **运行测试，记录错误**
   ```bash
   python scripts/test_e2e_single_account.py > test_log.txt 2>&1
   ```

2. **根据错误修改代码**
   - 配置问题 → 修改`.env`或`src/core/config.py`
   - API调用问题 → 修改对应模块（`src/content/`, `src/publishing/`等）
   - 业务逻辑问题 → 修改对应模块代码

3. **提交修改到测试分支**
   ```bash
   git add <修改的文件>
   git commit -m "fix: 描述修复的问题"
   ```

4. **重新运行测试**
   ```bash
   python scripts/test_e2e_single_account.py
   ```

5. **重复步骤2-4，直到测试通过**

6. **测试通过后合并到main**
   ```bash
   git checkout main
   git merge test/e2e-single-account --no-ff
   ```

---

## 📝 注意事项

- ⚠️ 本测试脚本**不会实际发布评论到Reddit**（M5阶段仅模拟）
- ⚠️ 如需真实发布，需修改M5阶段的代码（取消注释实际发布逻辑）
- ⚠️ 建议在测试子版（如r/test）进行真实发布测试
- ⚠️ 每次测试会消耗OpenAI API额度（约$0.01-0.02）

---

**下一步**: 运行测试，遇到问题在测试分支修复，测试通过后合并到main！
